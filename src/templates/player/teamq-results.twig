{% set user = request.session.get("user") %}
{% set user_permissions = request.session.get("user_permissions") %}
{% set playerq_visible_permission = user_permissions.permissions.PlayerQ.visible == "1" or user.user_group_id == "1" %}
{% set playerq_create_permission = user_permissions.permissions.PlayerQ.create == "1" or user.user_group_id == "1" %}

{% if playerq_visible_permission %}
    <div class="row mt-4">
        {% if playerq_create_permission %}
            <div class="col-12 col-lg-4">
                <h3 class="text-uppercase pb-2 d-flex justify-content-between">
                    <span class="d-block">Description</span>
                    <button type="button" class="btn btn-soft-green" onclick="submitPlayerText()"> Submit</button>
                </h3>
            </div>
        {% endif %}
        <div class="col-12 col-lg">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link font-weight-bold text-black active" data-toggle="tab" href="#" onclick="showResultTab('player-report')">Player</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link font-weight-bold text-black" data-toggle="tab" href="#" onclick="showResultTab('coach-report')">Coach</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link font-weight-bold text-black" data-toggle="tab" href="#" onclick="showResultTab('scout-report')">Scout</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="row">
        {% if playerq_create_permission %}
            <div class="col-12 col-lg-4">
                <form id="text-submit">
                    <label class="sr-only" for="playerText">Transcription Text</label>
                    <textarea id="playerText" name="playerText" class="form-control mt-2" rows="20"
                              placeholder="Text to submit"
                              onkeyup="$('#wordCount').html(countWords('playerText'))">{{ text }}</textarea>
                    {{ ("textSubmitForm"~RANDOM()) | formToken }}
                    <div id="submitResultMessage"></div>
                </form>
                <div class="mt-1">
                    <b
                            style="
                        font-family: 'Inter', 'Arial', sans-serif;
                        font-weight: 600;
                        font-size: 14px;
                        color: #000000;
                    "
                    >
                        Word Count:
                    </b>
                    <span
                            id="wordCount"
                            style="
                        font-family: 'Inter', 'Arial', sans-serif;
                        font-weight: 400;
                        font-size: 14px;
                        color: #000000;
                    "
                    >
                    0
                </span>
                </div>
            </div>
        {% endif %}
        <div class="col-12 col-lg">
            <div id="player-report" class="pt-1 pb-3 px-1 result-tab">
                {% if results.player %}
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mt-3 mb-3" style="
                        font-family: 'Inter', 'Arial', sans-serif;
                        font-weight: 700;
                        font-size: 24px;
                        color: #000000;
                    ">
                        Player Results
                    </h5>

                    <div class="row justify-content-between">
                        <a
                                href="{{ url }}/player/{{ candidate_id }}/pdf/report/player/download"
                                class="py-1 px-2 btn mr-2 text-soft-green text-inter download-btn"
                        >
                            Download Report
                        </a>
                        <button
                                onclick="viewReport(`{{ url }}/player/{{ candidate_id }}/pdf/report/player/download`, '{{ player.first_name }} {{ player.last_name }} Player Report')"
                                class="py-1 px-2 btn mr-2 text-soft-green text-inter view-btn"
                        >
                            View Report
                        </button>
                    </div>
                </div>
                {{ results.player }}
                {% else %}
                    <p class="text-muted">Player report unavailable. Submit the transcript to get the report.</p>
                {% endif %}
            </div>
            <div id="coach-report" class="pt-1 pb-3 px-1 result-tab">
                {% if results.coach %}
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mt-3 mb-3" style="
                        font-family: 'Inter', 'Arial', sans-serif;
                        font-weight: 700;
                        font-size: 24px;
                        color: #000000;
                    ">
                        Coaching Results
                    </h5>
                    <div class="row justify-content-between">
                        <a
                                href="{{ url }}/player/{{ player.candidate_id }}/pdf/report/coach/download"
                                class="py-1 px-2 btn mr-2 text-soft-green text-inter download-btn"
                        >
                            Download Report
                        </a>
                        <button
                                onclick="viewReport(`{{ url }}/player/{{ candidate_id }}/pdf/report/coach/download`, '{{ player.first_name }} {{ player.last_name }} Coaching Report')"
                                class="py-1 px-2 btn mr-2 text-soft-green text-inter view-btn"
                        >
                            View Report
                        </button>
                    </div>
                </div>
                {{ results.coach }}
                {% else %}
                    <p class="text-muted">Coaching report unavailable. Submit the transcript to get the report.</p>
                {% endif %}
            </div>
            <div id="scout-report" class="pt-1 pb-3 px-1 result-tab">
                {% if results.scout %}
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mt-3 mb-3" style="
                        font-family: 'Inter', 'Arial', sans-serif;
                        font-weight: 700;
                        font-size: 24px;
                        color: #000000;
                    ">
                        Scouting Results
                    </h5>
                    <div class="row justify-content-between">
                        <a
                                href="{{ url }}/player/{{ player.candidate_id }}/pdf/report/scout/download"
                                class="py-1 px-2 btn mr-2 text-soft-green text-inter download-btn"
                        >
                            Download Report
                        </a>
                        <button
                                onclick="viewReport(`{{ url }}/player/{{ candidate_id }}/pdf/report/scout/download`, '{{ player.first_name }} {{ player.last_name }} Scouting Report')"
                                class="py-1 px-2 btn mr-2 text-soft-green text-inter view-btn"
                        >
                            View Report
                        </button>
                    </div>
                </div>
                {{ results.scout }}
                {% else %}
                    <p class="text-muted">Scouting report unavailable. Submit the transcript to get the report.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="modal modal-fullscreen" role="document" id="reportModal">
        <div class="modal-content overflow-hidden">
            <div class="modal-header border-0">
                <h3 class="modal-title text-black text-anton" id="reportModalLabel"></h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="gradient-separator mb-0"></div>
            <div class="modal-body p-0">
                <div id="pdfLoader" class="flex-column align-items-center justify-content-center h-100" style="background-color: rgba(255, 255, 255, 0.8);">
                    <h5 id="importLoadText" class="text-anton text-black pb-2">Loading Report ...</h5>
                    <div style="width: 5rem; height: 5rem;" class="spinner-border" role="status">
                        <span class="sr-only text-black">Loading Report ...</span>
                    </div>
                </div>
                <div id="reportContent" class="h-100 w-100"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-soft-green" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
    <script>
        function showResultTab(tabName) {
            $(".result-tab").hide();
            $("#" + tabName).show();
        }

        showResultTab("player-report");

        function countWords(input) {
            // Get the input text value
            let text = document.getElementById(input).value;

            // Initialize the word counter
            let numWords = 0;

            for (let i = 0; i < text.length; i++) {
                let currentCharacter = text[i];

                // Check if the character is a space
                if (currentCharacter === " ") {
                    numWords += 1;
                }
            }
            numWords += 1;
            return numWords;
        }

        $('#wordCount').html(countWords('playerText'));

        function viewReport(url, label) {
            $('#reportModal').modal('show');
            // clear the object data and reload
            document.getElementById('reportContent').innerHTML = '';

            // create the object and append it to the reportContent div
            let iframe = document.createElement('iframe');
            iframe.id = 'reportFrame';
            iframe.src = `${url}?content_disposition=inline`;
            iframe.width = '100%';
            iframe.height = '100%';
            iframe.classList.add('h-100');
            iframe.onload = function() {
                $('#pdfLoader').removeClass('d-flex').addClass('d-none');
            };

            document.getElementById('reportContent').appendChild(iframe);

            $('#pdfLoader').addClass('d-flex').removeClass('d-none');
            $('#reportModalLabel').html(label ? label : 'Player Report');
        }
        // Hide loader when PDF loads or fails

        {% if playerq_create_permission %}
            function submitPlayerText() {
                $('#submitResultMessage').html(`<div class="text-center" style="position: fixed; top:0; left: 0; width: 100vw; height: 100vh; z-index: 200;">
                    <div class="d-flex flex-column align-items-center justify-content-center h-100" style="background-color: rgba(255, 255, 255, 0.8);">
                        <h5 id="submitLoadText" class="text-anton text-black pb-2">Submitting Transcript ...</h5>
                        <div style="width: 5rem; height: 5rem;" class="spinner-border" role="status">
                        <span class="sr-only text-black">Submitting Transcript ...</span>
                    </div>
                </div>`);
                submitForm("text-submit", "/api/athlete/{{ player.id }}/results", "", function () {
                    loadPage('/api/athlete/{{ player.id }}/results', 'tabTeamQ')
                });
            }
        {% endif %}
    </script>
{% endif %}
