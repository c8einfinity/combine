{% set user = request.session.get("user") %}
{% set user_permissions = request.session.get("user_permissions") %}
{% set home_visible_permission = user_permissions.permissions.Home.visible == "1" or user.user_group_id == "1" %}
{% set athletes_visible_permission = user_permissions.permissions.Athletes.visible == "1" or user.user_group_id == "1" %}
{% set users_visible_permission = user_permissions.permissions.Users.visible == "1" or user.user_group_id == "1" %}
{% set user_groups_visible_permission = user_permissions.permissions.User_Groups.visible == "1" or user.user_group_id == "1" %}
{% set queue_visible_permission = user_permissions.permissions.Queue.visible == "1" or user.user_group_id == "1" %}
{% set receptiviti_csv_visible_permission = user_permissions.permissions.Receptiviti_CSV.visible == "1" or user.user_group_id == "1" %}

{% extends "base.twig" %}

{% block navigation %}
    <nav class="navbar navbar-expand-lg navbar-light bg-white py-3">
        <a class="navbar-brand" href="/dashboard">
            <img src="/images/logos/qfinder-logo-dark.svg" class="img-fluid ml-3 mr-0 mr-md-4" alt="QFinder Logo"/>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto mt-3 mt-lg-0">
                {% if home_visible_permission %}
                    <li class="nav-item mx-1">
                        <a class="nav-link px-4 py-2 px-lg-3 py-lg-1" id="homeLink" href="#" role="button" title="Home"
                           onclick="loadPage('/dashboard/home', 'content'); teamQNavSetActive(this);">Home<span
                                    class="sr-only">(current)</span></a>
                    </li>
                {% endif %}
                {% if athletes_visible_permission %}
                    <li class="nav-item mx-1">
                        <a class="nav-link px-4 py-2 px-lg-3 py-lg-1" id="athleteLink" href="#" role="button" title="Athletes"
                           onclick="loadPage('/dashboard/athletes/all', 'content'); teamQNavSetActive(this);">Athletes</a>
                    </li>
                {% endif %}
                {% if users_visible_permission %}
                    <li class="nav-item mx-1">
                        <a class="nav-link px-4 py-2 px-lg-3 py-lg-1" id="usersLink" href="#" role="button" title="Users"
                           onclick="loadPage('/api/users/landing', 'content'); teamQNavSetActive(this);">Users</a>
                    </li>
                {% endif %}
                {% if user_groups_visible_permission %}
                    <li class="nav-item mx-1">
                        <a class="nav-link px-4 py-2 px-lg-3 py-lg-1" id="userGroupsLink" href="#" role="button" title="User Groups"
                           onclick="loadPage('/api/user_groups/landing', 'content'); teamQNavSetActive(this);">
                            User Groups
                        </a>
                    </li>
                {% endif %}
                {% if queue_visible_permission %}
                    <li class="nav-item mx-1">
                        <a class="nav-link px-4 py-2 px-lg-3 py-lg-1" id="queueLink" href="#" role="button" title="Queue"
                           onclick="loadPage('/dashboard/queue', 'content'); teamQNavSetActive(this);">Queue</a>
                    </li>
                {% endif %}
                {% if receptiviti_csv_visible_permission %}
                    <li class="nav-item mx-1">
                        <a class="nav-link px-4 py-2 px-lg-3 py-lg-1" id="receptivitiCsvLink" href="/api/receptiviti/export"
                           target="_blank" title="Receptivi CSV">
                            Receptivi CSV
                        </a>
                    </li>
                {% endif %}
                <li class="nav-item mx-1 d-block d-lg-none">
                    <a class="nav-link px-4 py-2 px-lg-3 py-lg-1" href="/logout" title="Logout">Logout</a>
                </li>
            </ul>
            <div class="dropdown">
                <div class="d-lg-block d-none">
                    <button type="button"
                            class="btn dropdown-toggle bg-transparent border-0 text-black font-weight-bold"
                            data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">

                        <img class="avatar-default mr-2" src="/images/avatar.svg" alt="Avatar"/>
                        {{ user.first_name }} {{ user.last_name }}
                    </button>
                    <div class="dropdown-menu dropdown-menu-right">

                        <a class="dropdown-item text-black" href="/logout">
                            <i class="fa-solid fa-right-from-bracket pr-2"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

{% endblock %}

{% block content_public %}
    <div id="content" class="mt-4 my-4"></div>
    <script>
        {% if home_visible_permission %}
        loadPage('/dashboard/home', 'content');
        teamQNavSetActive($('#homeLink')[0]);
        {% else %}
        loadPage("{{ user_permissions.landing_page_url }}", 'content');
        teamQNavSetActive($("#{{ user_permissions.landing_page_nav_element_id }}")[0]);
        {% endif %}

        {# const socket = new ReconnectingWebSocket("ws://{{ request.headers.host }}/websocket/feed"); #}

        // // Do something when connected
        // socket.addEventListener("open", (event) => {
        //     console.log("Websocket connected!");
        //     socket.send("Ping!")
        // });
        //
        // // Listen for messages
        // socket.addEventListener("message", (event) => {
        //     console.log("Message from server ", event.data);
        //     //socket.send('Received!')
        // });
    </script>
    <script>
        // Modified teamQNavSetActive function
        function teamQNavSetActive(element, initialLoad = false) {
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to clicked item's parent
            element.parentElement.classList.add('active');

            // Store both the active tab ID and page URL in localStorage
            if (!initialLoad) {
                localStorage.setItem('activeNavItem', element.id);
                const urlMatch = element.getAttribute('onclick').match(/loadPage\('([^']+)'/);
                if (urlMatch && urlMatch[1]) {
                    localStorage.setItem('lastActivePage', urlMatch[1]);
                }
            }
        }

        // On page load
        document.addEventListener('DOMContentLoaded', function() {
            const activeNavId = localStorage.getItem('activeNavItem');
            const lastActivePage = localStorage.getItem('lastActivePage');

            // If we have a stored page
            if (lastActivePage) {
                // Find the corresponding nav item
                const navLinks = document.querySelectorAll('.nav-link');
                let foundLink = null;

                navLinks.forEach(link => {
                    const onclickContent = link.getAttribute('onclick');
                    if (onclickContent && onclickContent.includes(lastActivePage)) {
                        foundLink = link;
                    }
                });

                if (foundLink) {
                    // Set the tab as active
                    teamQNavSetActive(foundLink, true);
                    // Load the stored page
                    loadPage(lastActivePage, 'content');
                    return;
                }
            }

            // If no stored page found, do nothing (leave as current page)
            if (activeNavId) {
                const activeElement = document.getElementById(activeNavId);
                if (activeElement) {
                    teamQNavSetActive(activeElement, true);
                }
            }
        });
    </script>
{% endblock %}
